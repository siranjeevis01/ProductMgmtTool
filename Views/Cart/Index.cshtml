@model ProductMgmt.Models.Cart
@using System.Globalization

@{
    ViewData["Title"] = "Shopping Cart";
}

<h2 class="mb-4 text-dark fw-bold">
    <i class="bi bi-cart me-2"></i> Shopping Cart
</h2>

@if (Model.Items.Any())
{
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Items)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="@(item.Product.ImageUrl ?? "https://via.placeholder.com/80x80/cccccc/969696?text=No+Image")" 
                                                     class="img-thumbnail me-3" style="width: 80px; height: 80px; object-fit: cover;"
                                                     onerror="this.src='https://via.placeholder.com/80x80/cccccc/969696?text=No+Image'">
                                                <div>
                                                    <h6 class="mb-0">@item.Product.Name</h6>
                                                    <small class="text-muted">SKU: @item.Product.SKU</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="align-middle">@item.Product.Price.ToString("C", new CultureInfo("en-IN"))</td>
                                        <td class="align-middle">
                                            <div class="input-group input-group-sm" style="width: 100px;">
                                                <button class="btn btn-outline-secondary minus-btn" 
                                                        data-item-id="@item.Id" type="button">-</button>
                                                <input type="number" class="form-control text-center quantity-input" 
                                                       value="@item.Quantity" min="1" data-item-id="@item.Id">
                                                <button class="btn btn-outline-secondary plus-btn" 
                                                        data-item-id="@item.Id" type="button">+</button>
                                            </div>
                                        </td>
                                        <td class="align-middle fw-bold">
                                            @((item.Quantity * item.Product.Price).ToString("C", new CultureInfo("en-IN")))
                                        </td>
                                        <td class="align-middle">
                                            <form asp-action="RemoveItem" method="post">
                                                <input type="hidden" name="itemId" value="@item.Id" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <a asp-controller="Product" asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Continue Shopping
                </a>
                <form asp-action="Clear" method="post">
                    <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to clear your cart?');">
                        <i class="bi bi-trash me-1"></i> Clear Cart
                    </button>
                </form>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    @{
                        var subtotal = Model.Items.Sum(i => i.Quantity * i.Product.Price);
                        var tax = subtotal * 0.1m; 
                        var total = subtotal + tax;
                    }
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>@subtotal.ToString("C", new CultureInfo("en-IN"))</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax (10%):</span>
                        <span>@tax.ToString("C", new CultureInfo("en-IN"))</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3 fw-bold fs-5">
                        <span>Total:</span>
                        <span>@total.ToString("C", new CultureInfo("en-IN"))</span>
                    </div>
                    
                    <a asp-controller="Checkout" asp-action="Index" class="btn btn-success w-100 py-2">
                        <i class="bi bi-lock me-1"></i> Proceed to Checkout
                    </a>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="text-center py-5">
        <i class="bi bi-cart-x" style="font-size: 4rem; color: #ccc;"></i>
        <h3 class="mt-3 text-muted">Your cart is empty</h3>
        <p class="text-muted">Start shopping to add items to your cart</p>
        <a asp-controller="Product" asp-action="Index" class="btn btn-primary mt-3">
            <i class="bi bi-bag me-1"></i> Continue Shopping
        </a>
    </div>
}

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('.plus-btn').click(function() {
            var input = $(this).siblings('.quantity-input');
            var value = parseInt(input.val());
            input.val(value + 1);
            updateCartItem($(this).data('item-id'), value + 1);
        });
        
        $('.minus-btn').click(function() {
            var input = $(this).siblings('.quantity-input');
            var value = parseInt(input.val());
            if (value > 1) {
                input.val(value - 1);
                updateCartItem($(this).data('item-id'), value - 1);
            }
        });
        
        $('.quantity-input').change(function() {
            var value = parseInt($(this).val());
            if (isNaN(value) || value < 1) {
                $(this).val(1);
                value = 1;
            }
            updateCartItem($(this).data('item-id'), value);
        });
        
        function updateCartItem(itemId, quantity) {
            $.post('@Url.Action("UpdateItem", "Cart")', {
                itemId: itemId,
                quantity: quantity
            }, function() {
                location.reload();
            });
        }
    });
</script>
}